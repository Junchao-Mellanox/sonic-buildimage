From c9ad86491ab078f5009d9c953d6da8e50d84a33a Mon Sep 17 00:00:00 2001
From: Junchao-Mellanox <junchao@nvidia.com>
Date: Wed, 5 Jul 2023 12:09:58 +0800
Subject: [PATCH 2/4] Disable hw-mgmt on SimX platforms

---
 usr/usr/bin/hw-management-ready.sh | 11 +++++++++++
 usr/usr/bin/hw-management.sh       |  9 +++++++++
 2 files changed, 20 insertions(+)

diff --git a/usr/usr/bin/hw-management-ready.sh b/usr/usr/bin/hw-management-ready.sh
index 2b736d2..679371e 100755
--- a/usr/usr/bin/hw-management-ready.sh
+++ b/usr/usr/bin/hw-management-ready.sh
@@ -51,6 +51,17 @@ if [ -d /var/run/hw-management ]; then
 	rm -fr /var/run/hw-management
 fi

+if [ -n "$(lspci -vvv | grep SimX)" ]; then
+    if systemctl is-enabled --quiet hw-management-tc; then
+        echo "Stopping and disabling hw-management-tc on SimX"
+        systemctl stop hw-management-tc
+        systemctl disable hw-management-tc
+    fi
+    echo "Start Chassis HW management service."
+    logger -t hw-management -p daemon.notice "Start Chassis HW management service."
+    exit 0
+fi
+
 case $board_type in
 VMOD0014)
 	if [ ! -d /sys/devices/pci0000:00/0000:00:1f.0/NVSN2201:00/mlxreg-hotplug/hwmon ]; then
diff --git a/usr/usr/bin/hw-management.sh b/usr/usr/bin/hw-management.sh
index 120bf2e..4962307 100755
--- a/usr/usr/bin/hw-management.sh
+++ b/usr/usr/bin/hw-management.sh
@@ -2494,6 +2494,13 @@ do_chip_down()
 	/usr/bin/hw-management-thermal-events.sh change hotplug_asic down %S %p
 }

+check_simx()
+{
+    if [ -n "$(lspci -vvv | grep SimX)" ]; then
+        exit 0
+    fi
+}
+
 __usage="
 Usage: $(basename "$0") [Options]

@@ -2520,6 +2527,8 @@ Options:
 	reset-cause	Output system reset cause.
 "

+check_simx
+
 case $ACTION in
 	start)
 		if [ -d /var/run/hw-management ]; then
--
1.9.1

